#cloud-config
#
# Qubic Bob Node - Cloud-Init
# https://github.com/qubic/core-bob
#
# Requirements: 16GB RAM, 4+ cores, 100GB SSD
#
# IMPORTANT: Replace YOUR_SEED and YOUR_ALIAS before deploying!
#

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - ufw

runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com | sh

  # Configure firewall
  - ufw allow 22/tcp
  - ufw allow 21842/tcp
  - ufw allow 40420/tcp
  - ufw --force enable

  # Create config directory
  - mkdir -p /opt/qubic-bob

  # Create .env config
  - |
    cat > /opt/qubic-bob/.env << 'EOF'
    NODE_SEED=YOUR_SEED
    NODE_ALIAS=YOUR_ALIAS
    EOF
  - chmod 600 /opt/qubic-bob/.env

  # Create docker-compose.yml
  - |
    cat > /opt/qubic-bob/docker-compose.yml << 'EOF'
    services:
      qubic-bob:
        image: qubiccore/bob:latest
        container_name: qubic-bob
        restart: unless-stopped
        ports:
          - "21842:21842"
          - "40420:40420"
        env_file:
          - .env
        volumes:
          - qubic-bob-redis:/data/redis
          - qubic-bob-kvrocks:/data/kvrocks
          - qubic-bob-data:/data/bob

      watchtower:
        image: containrrr/watchtower
        container_name: watchtower
        restart: unless-stopped
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
        command: --interval 300 qubic-bob

    volumes:
      qubic-bob-redis:
      qubic-bob-kvrocks:
      qubic-bob-data:
    EOF

  # Start containers
  - cd /opt/qubic-bob && docker compose up -d
