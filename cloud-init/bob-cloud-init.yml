#cloud-config
#
# Qubic Bob Node - Cloud-Init
# https://github.com/qubic/core-bob
#
# Requirements: 16GB RAM, 4+ cores, 100GB SSD
#
# IMPORTANT: Replace YOUR_SEED and YOUR_ALIAS before deploying!
#

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - ufw

runcmd:
  # Install Docker
  - curl -fsSL https://get.docker.com | sh

  # Configure firewall
  - ufw allow 22/tcp
  - ufw allow 21842/tcp
  - ufw allow 40420/tcp
  - ufw --force enable

  # Create directory
  - mkdir -p /opt/qubic-bob

  # Create .env file (edit this to change seed/alias)
  - |
    cat > /opt/qubic-bob/.env << 'EOF'
    NODE_SEED=YOUR_SEED
    NODE_ALIAS=YOUR_ALIAS
    EOF
  - chmod 600 /opt/qubic-bob/.env

  # Create bob.json from .env values
  - |
    source /opt/qubic-bob/.env
    cat > /opt/qubic-bob/bob.json << EOF
    {
      "log-level": "info",
      "run-server": true,
      "server-port": 21842,
      "rpc-port": 40420,
      "node-seed": "${NODE_SEED}",
      "node-alias": "${NODE_ALIAS}"
    }
    EOF
  - chmod 600 /opt/qubic-bob/bob.json

  # Create docker-compose.yml
  - |
    cat > /opt/qubic-bob/docker-compose.yml << 'EOF'
    services:
      qubic-bob:
        image: qubiccore/bob:latest
        container_name: qubic-bob
        restart: unless-stopped
        ports:
          - "21842:21842"
          - "40420:40420"
        volumes:
          - /opt/qubic-bob/bob.json:/app/bob.json:ro
          - /opt/qubic-bob/data:/data

      watchtower:
        image: containrrr/watchtower
        container_name: watchtower
        restart: unless-stopped
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
        command: --interval 300 qubic-bob
    EOF

  # Start containers
  - cd /opt/qubic-bob && docker compose up -d
